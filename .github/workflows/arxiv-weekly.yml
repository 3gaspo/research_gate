name: arXiv Weekly Digest

on:
  schedule:
    # Runs every morning
    - cron: "0 7 * * *"   # every day at 07:00 UTC
  workflow_dispatch:
    inputs:
      categories:
        description: "Comma-separated arXiv categories (default: cs.LG)"
        required: false
      keywords:
        description: "Comma-separated keywords (default: federated learning,time series)"
        required: false
      days:
        description: "Lookback window in days (default: 3)"
        required: false
      include_abstracts:
        description: "Include 1-line abstract snippets (true/false)"
        required: false
      intersect_keywords:
        description: "AND condition on keywords (true/false)"
        required: false
      max_results:
        description: "Max results before filtering (default: 500)"
        required: false
      delay:
        description: "Delay between API calls in seconds (default: 3.2)"
        required: false
      page_size:
        description: "Page size for arXiv client (default: 100)"
        required: false
      retries:
        description: "Retry count for transient errors (default: 4)"
        required: false

jobs:
  run-and-email:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install arxiv

      - name: Run arXiv search
        env:
          # Defaults (can be overridden via workflow_dispatch inputs)
          ARXIV_CATEGORIES:  ${{ inputs.categories != '' && inputs.categories || 'cs.LG' }}
          ARXIV_KEYWORDS:    ${{ inputs.keywords   != '' && inputs.keywords   || 'federated learning,time series' }}
          ARXIV_DAYS:        ${{ inputs.days       != '' && inputs.days       || '3' }}
          INCLUDE_ABSTRACTS: ${{ inputs.include_abstracts != '' && inputs.include_abstracts || 'false' }}
          INTERSECT_KW:      ${{ inputs.intersect_keywords != '' && inputs.intersect_keywords || 'false' }}
          MAX_RESULTS:       ${{ inputs.max_results != '' && inputs.max_results || '500' }}
          ARXIV_DELAY:       ${{ inputs.delay != '' && inputs.delay || '3.2' }}
          ARXIV_PAGE_SIZE:   ${{ inputs.page_size != '' && inputs.page_size || '100' }}
          ARXIV_RETRIES:     ${{ inputs.retries != '' && inputs.retries || '4' }}
        run: |
          python scripts/arxiv_weekly.py > results.txt
          echo "Preview of results:"
          head -n 40 results.txt || true

      - name: Capture email body from file
        id: getbody
        shell: bash
        run: |
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat results.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "arXiv Weekly Digest"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          body: ${{ steps.getbody.outputs.body }}
          attachments: results.txt
