name: arXiv Weekly Digest

on:
  schedule:
    # Runs every Monday at 07:00 UTC (â‰ˆ Monday morning in Europe/Paris).
    # Adjust if you want a different time.
    - cron: "0 7 * * 1"
  workflow_dispatch:
    inputs:
      categories:
        description: "Comma-separated arXiv categories"
        required: false
      keywords:
        description: "Comma-separated keywords"
        required: false
      days:
        description: "Lookback window in days"
        required: false
      include_abstracts:
        description: "Include 1-line abstract snippets (true/false)"
        required: false
      max_results:
        description: "Max results fetched before filtering"
        required: false

jobs:
  run-and-email:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install arxiv

      - name: Run arXiv search
        env:
          # Defaults (can be overridden via workflow_dispatch inputs)
          ARXIV_CATEGORIES: ${{ inputs.categories != '' && inputs.categories || 'cs.LG,stat.ML,cs.AI,cs.CL,cs.CV' }}
          ARXIV_KEYWORDS:   ${{ inputs.keywords   != '' && inputs.keywords   || 'federated learning,time series' }}
          ARXIV_DAYS:       ${{ inputs.days       != '' && inputs.days       || '7' }}
          INCLUDE_ABSTRACTS:${{ inputs.include_abstracts != '' && inputs.include_abstracts || 'false' }}
          MAX_RESULTS:      ${{ inputs.max_results != '' && inputs.max_results || '200' }}
        run: |
          python scripts/arxiv_weekly.py > results.txt
          echo "Preview:"
          head -n 40 results.txt || true

      - name: Capture email body from file
        id: getbody
        shell: bash
        run: |
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat results.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "arXiv Weekly Digest"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          body: ${{ steps.getbody.outputs.body }}
          # Optional: also attach the txt file
          attachments: results.txt
