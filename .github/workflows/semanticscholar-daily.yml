name: Semantic Scholar Daily Digest

on:
  schedule:
    - cron: "0 7 * * *"   # every day at 07:00 UTC
  workflow_dispatch:
    inputs:
      keywords:
        description: "Comma-separated keywords (default: federated learning,time series)"
        required: false
      days:
        description: "Lookback window in days (default: 3)"
        required: false
      include_abstracts:
        description: "Include 1-line abstract snippets (true/false)"
        required: false
      intersect_keywords:
        description: "AND condition across keywords (true/false)"
        required: false
      max_results:
        description: "Max results to fetch (default: 100)"
        required: false
      page_size:
        description: "Page size (default: 50)"
        required: false
      delay:
        description: "Delay between API calls in seconds (default: 1.5)"
        required: false
      fields_of_study:
        description: "Comma-separated fields (e.g., Computer Science,Mathematics)"
        required: false

jobs:
  run-and-email:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run Semantic Scholar search
        env:
          S2_KEYWORDS:        ${{ inputs.keywords != '' && inputs.keywords || 'federated learning,time series' }}
          S2_DAYS:            ${{ inputs.days != '' && inputs.days || '3' }}
          INCLUDE_ABSTRACTS:  ${{ inputs.include_abstracts != '' && inputs.include_abstracts || 'false' }}
          S2_INTERSECT_KW:    ${{ inputs.intersect_keywords != '' && inputs.intersect_keywords || 'false' }}
          S2_MAX_RESULTS:     ${{ inputs.max_results != '' && inputs.max_results || '100' }}
          S2_PAGE_SIZE:       ${{ inputs.page_size != '' && inputs.page_size || '50' }}
          S2_DELAY:           ${{ inputs.delay != '' && inputs.delay || '1.5' }}
          S2_FIELDS:          ${{ inputs.fields_of_study != '' && inputs.fields_of_study || '' }}
          # Optional API key (secret). Not required but helps raise rate limits.
          S2_API_KEY:         ${{ secrets.S2_API_KEY }}
        run: |
          python scripts/semanticscholar_digest.py > results_s2.txt
          echo "Preview of results:"
          head -n 40 results_s2.txt || true

      - name: Capture email body from file
        id: getbody
        shell: bash
        run: |
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat results_s2.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Semantic Scholar Daily Digest"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          body: ${{ steps.getbody.outputs.body }}
          attachments: results_s2.txt
